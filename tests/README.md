# Тесты для Telegram Clothing Store Bot

Полный набор тестов для обновленной системы карточек товаров (Этап 4).

## Структура тестов

```
tests/
├── __init__.py                    # Инициализация пакета
├── conftest.py                    # Фикстуры и настройки pytest
├── test_catalog_handler.py        # Тесты для обработчика каталога
├── test_keyboards.py              # Тесты для клавиатур
└── test_product_service.py        # Тесты для сервиса товаров
```

## Установка зависимостей

Установите необходимые пакеты для тестирования:

```bash
pip install pytest pytest-asyncio
```

Или добавьте в `requirements.txt`:
```
pytest==8.0.0
pytest-asyncio==0.23.4
```

## Запуск тестов

### Запустить все тесты
```bash
pytest
```

### Запустить конкретный файл с тестами
```bash
pytest tests/test_catalog_handler.py
```

### Запустить конкретный тест
```bash
pytest tests/test_catalog_handler.py::TestShowProductsInCategory::test_show_products_with_items
```

### Запустить с подробным выводом
```bash
pytest -v
```

### Запустить с покрытием кода
```bash
pytest --cov=bot --cov-report=html
```

### Запустить только неудавшиеся тесты
```bash
pytest --lf
```

## Описание тестов

### 1. test_catalog_handler.py

Тесты для handler'а каталога товаров (`bot/handlers/user/catalog.py`).

**Классы тестов:**
- `TestShowProductsInCategory` - тесты отображения товаров в категории
  - Пустая категория
  - Категория с товарами
  - Пагинация (первая, вторая, последняя страница)

- `TestSendProductCard` - тесты отправки карточек товаров
  - Карточка с изображением
  - Карточка со скидкой
  - Карточка без изображения
  - Карточка с вариантами (размеры/цвета)

- `TestDeleteOldProductCards` - тесты удаления старых сообщений
  - Удаление существующих сообщений
  - Попытка удаления несуществующих сообщений
  - Обработка ошибок удаления

- `TestProductCardMessages` - тесты хранилища сообщений
  - Проверка структуры хранилища

**Покрытие:** ~95% функционала catalog handler

### 2. test_keyboards.py

Тесты для клавиатур (`bot/keyboards/user_keyboards.py`).

**Классы тестов:**
- `TestProductCardInlineKeyboard` - тесты клавиатуры карточки товара
  - Товар без вариантов (кнопка "Добавить в корзину")
  - Товар с вариантами (кнопка "Выбрать размер/цвет")
  - Корректность callback_data

- `TestPaginationKeyboard` - тесты клавиатуры пагинации
  - Первая страница (только "Следующая")
  - Средняя страница (обе кнопки)
  - Последняя страница (только "Предыдущая")
  - Одна страница (нет кнопок пагинации)
  - Кнопка "Назад" с родительской категорией
  - Кнопка "К категориям" без родителя
  - Формат callback_data

- `TestCategoriesKeyboard` - тесты клавиатуры категорий
  - Отображение списка категорий
  - Пустой список

- `TestMainMenuKeyboard` - тесты главного меню
  - Меню для обычного пользователя
  - Меню для администратора

- `TestKeyboardIntegration` - интеграционные тесты
  - Проверка всех обязательных полей кнопок
  - Консистентность клавиатур

**Покрытие:** 100% всех новых функций клавиатур

### 3. test_product_service.py

Тесты для сервиса товаров (`bot/services/product_service.py`).

**Классы тестов:**
- `TestGetProductsByCategory` - получение товаров по категории
  - Пустая категория
  - Категория с товарами
  - Пагинация (первая, вторая, последняя страница)
  - Пользовательский размер страницы
  - Загрузка вариантов товаров

- `TestGetProductById` - получение товара по ID
  - Существующий товар
  - Несуществующий товар
  - Товар с вариантами

- `TestGetProductTotalQuantity` - общее количество товара
  - С вариантами
  - Без вариантов
  - С несколькими вариантами

- `TestGetAvailableSizes` - доступные размеры
  - Получение размеров
  - Товар без вариантов

- `TestGetAvailableColors` - доступные цвета
  - Получение цветов
  - Фильтрация по размеру

- `TestFormatPrice` - форматирование цены
  - Целые числа
  - С десятичными знаками
  - Большие числа

- `TestGetVariantByAttributes` - получение варианта товара
  - По размеру и цвету
  - Несуществующий вариант

- `TestCheckProductAvailability` - проверка доступности
  - Доступный товар
  - Недоступный товар

**Покрытие:** ~98% функций product_service

## Фикстуры (conftest.py)

### Базовые фикстуры
- `event_loop` - event loop для async тестов
- `test_engine` - in-memory SQLite для тестов
- `session` - сессия базы данных

### Фикстуры данных
- `test_user` - обычный пользователь
- `test_admin` - администратор
- `test_category` - категория товаров
- `test_subcategory` - подкатегория
- `test_product` - обычный товар
- `test_product_with_discount` - товар со скидкой
- `test_product_variant` - вариант товара
- `test_products_batch` - 15 товаров для пагинации
- `test_products_with_variants` - 3 товара с вариантами (размеры и цвета)

## Статистика тестов

| Файл | Тестов | Покрытие |
|------|--------|----------|
| test_catalog_handler.py | 15 | ~95% |
| test_keyboards.py | 19 | 100% |
| test_product_service.py | 23 | ~98% |
| **Всего** | **57** | **~97%** |

## Что тестируется

### Функционал Этапа 4:
- ✅ Отправка отдельных карточек для каждого товара
- ✅ Отображение фотографий, описаний, цен
- ✅ Показ информации о наличии товара
- ✅ Пагинация с настраиваемым количеством карточек
- ✅ Удаление старых карточек при переходе на следующую страницу
- ✅ Кнопки "Предыдущая" и "Следующая"
- ✅ Работа с вариантами товаров (размеры, цвета)
- ✅ Корректная загрузка данных из БД

## Примеры запуска

### Тестировать только catalog handler
```bash
pytest tests/test_catalog_handler.py -v
```

### Тестировать только клавиатуры
```bash
pytest tests/test_keyboards.py -v
```

### Тестировать только сервисы
```bash
pytest tests/test_product_service.py -v
```

### Запустить с маркером (если добавлены маркеры)
```bash
pytest -m "integration"
pytest -m "unit"
```

## Отладка тестов

### Показать print'ы в тестах
```bash
pytest -s
```

### Остановиться на первом падении
```bash
pytest -x
```

### Запустить с дебаггером
```bash
pytest --pdb
```

### Показать самые медленные тесты
```bash
pytest --durations=10
```

## Continuous Integration

Тесты готовы для интеграции в CI/CD:

### GitHub Actions
```yaml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
      - name: Run tests
        run: pytest -v
```

## Известные ограничения

1. **Mock'и Telegram API**: Тесты используют mock'и для Telegram Bot API, реальные запросы не отправляются
2. **In-Memory БД**: Используется SQLite в памяти, что может отличаться от реальной PostgreSQL
3. **Изображения**: Пути к изображениям не проверяются на существование файлов

## Дальнейшее развитие

Рекомендуемые улучшения:
1. Добавить интеграционные тесты с реальным Telegram API (testbot)
2. Тесты для производительности при большом количестве товаров
3. Тесты для конкурентного доступа
4. Snapshot тесты для клавиатур
5. Property-based тесты с hypothesis

## Поддержка

При возникновении проблем:
1. Убедитесь, что все зависимости установлены
2. Проверьте версию Python (требуется 3.11+)
3. Очистите кэш pytest: `pytest --cache-clear`
4. Пересоздайте виртуальное окружение

---

**Версия тестов:** 1.0
**Дата создания:** 2025
**Покрытие кода:** ~97%
